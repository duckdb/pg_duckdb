SET duckdb.force_execution TO false;
SET duckdb.allow_community_extensions = true;
SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(6 rows)

SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          1
(1 row)

-- INSERT SHOULD TRIGGER UPDATE OF EXTENSIONS
SELECT duckdb.install_extension('icu');
 install_extension 
-------------------
 
(1 row)

-- Increases the sequence twice because we use ON CONFLICT DO UPDATE. So
-- the trigger fires for both INSERT and UPDATE internally.
SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          3
(1 row)

SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(6 rows)

-- Check that we can rerun this without issues
SELECT duckdb.install_extension('icu');
 install_extension 
-------------------
 
(1 row)

-- Increases the sequence twice because we use ON CONFLICT DO UPDATE. So
-- the trigger fires for both INSERT and UPDATE internally.
SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          5
(1 row)

SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(6 rows)

SELECT duckdb.install_extension('aws');
 install_extension 
-------------------
 
(1 row)

SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          7
(1 row)

SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 aws            | t      | t         | core
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(7 rows)

-- DELETE SHOULD TRIGGER UPDATE OF EXTENSIONS
-- But we do not unload for now (would require a restart of DuckDB)
DELETE FROM duckdb.extensions WHERE name = 'aws';
SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          8
(1 row)

SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 aws            | t      | t         | core
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(7 rows)

SELECT duckdb.install_extension('duckpgq', 'community');
ERROR:  (PGDuckDB/install_extension_cpp) HTTP Error: Failed to download extension "duckpgq" at URL "http://community-extensions.duckdb.org/v1.3.0/linux_amd64/duckpgq.duckdb_extension.gz" (HTTP 403)

Candidate extensions: "autocomplete", "ui", "md", "iceberg", "encodings"
For more info, visit https://duckdb.org/docs/stable/extensions/troubleshooting/?version=v1.3.0&platform=linux_amd64&extension=duckpgq
SELECT last_value FROM duckdb.extensions_table_seq;
 last_value 
------------
          8
(1 row)

SELECT * FROM duckdb.query($$ SELECT extension_name, loaded, installed, installed_from FROM duckdb_extensions() WHERE loaded and extension_name != 'jemalloc' $$);
 extension_name | loaded | installed | installed_from 
----------------+--------+-----------+----------------
 aws            | t      | t         | core
 core_functions | t      | t         | 
 httpfs         | t      | t         | 
 icu            | t      | t         | 
 json           | t      | t         | 
 parquet        | t      | t         | 
 pgduckdb       | t      | f         | 
(7 rows)

-- cleanup
TRUNCATE duckdb.extensions;
